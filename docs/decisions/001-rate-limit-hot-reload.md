# ADR 001: 限流配置热加载

## 状态
已接受

## 背景

网关最初支持 Backend 级别的限流配置热更新，但 Server 级别的限流配置需要重启服务才能生效。随着业务发展，需要更灵活的限流控制：

1. **运维需求**：不同路由可能有不同的流量特征，需要更精细的限流控制
2. **即时响应**：流量突增时需要立即调整限制，不能等待重启窗口
3. **级联配置**：需要支持多级限流配置的优先级覆盖机制

## 决策

实现 Server、Backend、Route 三级限流配置的完全热加载支持。

### 配置级别

| 级别 | 配置路径 | 优先级 |
|------|----------|--------|
| Route | `routes[].rateLimit` | 最高（1） |
| Backend | `backends[].rateLimit` | 中等（2） |
| Server | `server.rateLimit` | 默认（3） |

### 更新策略

- **QPS 限流器**：创建新实例，计数器重置为 0
- **连接限流器**：创建新实例，保留当前连接数
- **客户端限流器**：配置变更时自动清理所有现有客户端限流器

### 线程安全

- 使用 `AtomicReference` 保证配置切换的原子性
- 使用 `ConcurrentHashMap` 保证并发访问安全
- 配置更新过程中，现有请求继续使用旧配置，新请求使用新配置

## 后果

### 正面影响

- **运维效率**：限流配置变更无需重启，即时生效
- **精细控制**：支持路由级别的限流，满足不同业务的差异化需求
- **平滑过渡**：连接数限制收紧时，现有连接自然消亡，不强制断开

### 负面影响

- **瞬时超限**：QPS 限流器更新时计数器重置，更新瞬间可能超出新限制
- **客户端清理**：Server 级别的 per-client 限流器配置变更时，所有客户端限流器被清理

### 风险

- 限制收紧后，新连接可能在旧连接自然消亡前被拒绝
- 客户端限流器清理可能导致从宽松变严格时，现有客户端立即被限流

## 替代方案

### 方案 A：全量重启
- **优点**：实现简单，状态完全一致
- **缺点**：中断服务，影响所有连接

### 方案 B：仅 Backend 级别热加载
- **优点**：覆盖大部分场景
- **缺点**：无法支持路由级别的差异化限流

## 相关文档

- [限流模块设计](../developer/modules/ratelimit.md)
- [配置指南](../user/configuration.md)
- [rate-limit-hot-reload.md](../archive/rate-limit-hot-reload.md) - 原始功能文档

## 版本历史

- **v1.1** (当前): 新增 Route 级别限流配置
- **v1.0**: 首次实现 rateLimit 配置热加载功能
