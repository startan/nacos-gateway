# 架构设计

## 1. 整体架构

Nacos Gateway 是一个基于 Java + Vert.x 构建的高性能 HTTP 反向代理网关，专门为 Nacos 服务发现场景设计。

```
┌───────────────────────────────────────────────────────────┐
│                         客户端请求                          │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌───────────────────────────────────────────────────────────┐
│                      Nacos Gateway                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  HTTP Server │──│  路由匹配器    │──│  限流检查      │    │
│  │  (Vert.x)    │  │ (RouteMatcher)│  │(RateLimiter) │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
│         │                                    │               │
│         ▼                                    ▼               │
│  ┌──────────────┐                   ┌──────────────┐        │
│  │ 管理接口      │                   │ 负载均衡器     │        │
│  │(/health)     │                   │(LoadBalancer)│        │
│  └──────────────┘                   └──────────────┘        │
│                                             │                │
│         ┌─────────────────────────────────┼──────────┐      │
│         ▼                                 ▼          ▼      │
│  ┌───────────┐  ┌─────────────┐  ┌──────────────────┐     │
│  │ 健康检查    │  │ 连接管理器   │  │ 代理处理器         │     │
│  │(HealthCheck)│ │(ConnectionMgr)│ │ (ProxyHandler)  │     │
│  └───────────┘  └─────────────┘  └──────────────────┘     │
│                                        │                     │
│         ┌─────────────────────────────┼─────────────┐       │
│         ▼                             ▼             ▼       │
│  ┌──────────┐  ┌───────────┐  ┌──────────────┐           │
│  │HTTP/1 代理│  │HTTP/2 代理 │  │ gRPC 代理     │           │
│  └──────────┘  └───────────┘  └──────────────┘           │
└────────────────────────┬──────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ 后端服务 1   │  │ 后端服务 2   │  │ 后端服务 N   │
│ (Priority 1) │  │ (Priority 1) │  │ (Priority 2) │
└─────────────┘  └─────────────┘  └─────────────┘
```

## 2. 核心特性

| 特性 | 说明 |
|------|------|
| **多协议支持** | HTTP/1、HTTP/2、gRPC（完全透传，无需 proto 文件） |
| **智能路由** | 基于 Host 的通配符路由匹配 |
| **负载均衡** | 轮询、随机、最少连接三种策略 |
| **优先级分组** | 端点优先级机制，高优先级全挂才降级 |
| **健康检查** | HTTP/1 和 HTTP/2 探针，连续阈值机制 |
| **限流保护** | QPS + 并发连接数限流，支持 Route/Backend/Server 三级级联配置 |
| **配置热更新** | 支持文件监听和 Nacos 配置中心实时推送 |
| **连接管理** | 每个客户端连接对应一个后端连接 |

## 3. 数据流设计

### 3.1 请求处理流程

```
1. 接收请求
   ├─ HTTP Server (Vert.x) 接收客户端请求
   └─ 提取 Host、Path、Method 等信息

2. 路由匹配
   ├─ 检查是否为管理接口请求（/health）
   ├─ 根据 Host 匹配路由规则
   └─ 找到对应的后端服务配置

3. 限流检查
   ├─ 检查全局限流（QPS + 连接数）
   ├─ 检查路由级限流
   └─ 超限返回 429，否则继续

4. 端点选择
   ├─ 获取后端服务的所有健康端点
   ├─ 按优先级分组
   ├─ 选择最高优先级组
   └─ 在组内使用负载均衡策略选择端点

5. 代理转发
   ├─ 检测请求类型（HTTP/1、HTTP/2、gRPC）
   ├─ 创建对应类型的代理处理器
   ├─ 建立与后端的连接
   ├─ 转发请求头和请求体
   └─ 流式转发响应

6. 连接清理
   ├─ 请求完成后释放限流配额
   ├─ 通知负载均衡器连接关闭
   └─ 清理连接管理器中的记录
```

### 3.2 配置热更新流程

```
配置加载流程:
1. ServerBootstrap 启动
   └─ ConfigFileReaderFactory.getReader(configPath, vertx)
      └─ 根据协议前缀创建对应 Reader：
         ├─ file:// → FileConfigReader
         ├─ classpath:// → ClasspathConfigReader
         └─ nacos:// → NacosConfigReader

2. 读取配置内容
   └─ ConfigFileReader.readConfig()
      ├─ 文件系统：Files.readString()
      ├─ 类路径：getResourceAsStream()
      └─ Nacos：ConfigService.getConfig()

3. 解析和验证
   └─ ConfigLoader.loadFromString(configContent)
      ├─ yamlMapper.readValue() 解析 YAML
      └─ validate() 验证配置

4. 创建组件并启动服务
   └─ GatewayServerManager、ConfigReloader、ConfigWatcher

5. 启动配置监听（如果支持）
   └─ ConfigFileReader.watchConfig(callback)
      ├─ 文件系统：Vert.x 定时器轮询
      ├─ 类路径：空实现
      └─ Nacos：ConfigService.addListener()
```

```
配置变更流程:
1. 配置变更检测
   ├─ 文件系统：文件修改时间变化
   ├─ Nacos：Listener.receiveConfigInfo() 回调
   └─ 类路径：不支持

2. 触发回调
   └─ ConfigWatcher 注册的 callback
      └─ ConfigReloader.reload()

3. 重新加载
   ├─ ConfigFileReader.readConfig() 读取最新配置
   ├─ ConfigLoader.loadFromString() 解析
   └─ 更新各个组件（路由、后端、限流器等）
```

## 4. 核心组件

### 4.1 组件交互图

```
┌────────────────┐
│ ServerBootstrap│
│   启动器        │
└────────┬───────┘
         │
         │ 创建
         ▼
┌────────────────┐
│ GatewayServer  │
│  网关服务器     │
└────────┬───────┘
         │
         │ 初始化
         ▼
┌────────────────────────────────────┐
│      核心组件初始化                  │
│  ┌─────────────────────────────┐   │
│  │ RouteMatcher (路由匹配器)    │   │
│  │  - 匹配 Host 和 Path         │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ LoadBalancer (负载均衡器)    │   │
│  │  - RoundRobin/Random/LeastConn│  │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ HealthCheckManager (健康检查) │   │
│  │  - 定时探测端点健康状态         │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ RateLimitManager (限流)      │   │
│  │  - QPS + 连接数限流           │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ ConnectionManager (连接管理)  │   │
│  │  - 跟踪活动连接               │   │
│  └─────────────────────────────┘   │
└────────────────────────────────────┘
         │
         │ 处理请求
         ▼
┌────────────────────────────────────┐
│      请求处理流程                    │
│  1. 路由匹配 → RouteMatcher        │
│  2. 限流检查 → RateLimitManager    │
│  3. 端点选择 → LoadBalancer        │
│  4. 代理转发 → ProxyHandler        │
│  5. 连接清理 → ConnectionManager   │
└────────────────────────────────────┘
```

### 4.2 组件说明

| 组件 | 职责 |
|------|------|
| **RouteMatcher** | 匹配 Host 和 Path，找到对应后端 |
| **LoadBalancer** | 在多个端点间选择目标，支持多种策略 |
| **HealthCheckManager** | 定时探测端点健康状态 |
| **RateLimitManager** | QPS 和连接数限流 |
| **ConnectionManager** | 跟踪活动连接 |
| **ProxyHandler** | 处理 HTTP/1、HTTP/2、gRPC 代理转发 |

## 5. 设计原则

### 5.1 异步非阻塞
- 基于 Vert.x 的事件循环模型
- 所有 I/O 操作都是异步的
- 避免阻塞事件循环

### 5.2 线程安全
- 使用 ConcurrentHashMap 等并发集合
- 使用 AtomicInteger 等原子类
- 使用 Copy-on-Write 模式更新路由表

### 5.3 资源管理
- 及时释放连接
- 清理过期限流窗口
- 限制缓冲区大小

### 5.4 可观测性
- 详细的日志记录
- 健康检查接口
- 结构化日志输出

## 6. 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Java | 17+ | 开发语言 |
| Vert.x | 5.0.6 | 异步事件驱动框架 |
| Jackson | 2.16.0 | YAML 解析 |
| Logback | 1.4.11 | 日志框架 |
| SLF4J | 2.0.9 | 日志门面 |
| Nacos Client | 2.3.2 | 配置中心集成 |
